@model TeknikServis.Core.Entities.ServiceTicket
@using TeknikServis.Web.Extensions

@{
    ViewData["Title"] = "Servis Detayı";
    // --- YASAL SÜRE HESAPLAMALARI ---
    var yasalBitisTarihi = Model.CreatedDate.AddBusinessDays(21);
    var kalanIsGunu = yasalBitisTarihi.GetRemainingBusinessDays();
    var toplamSure = (yasalBitisTarihi - Model.CreatedDate).TotalDays;
    var gecenSure = (DateTime.Now - Model.CreatedDate).TotalDays;
    var yuzde = (toplamSure > 0) ? (int)((gecenSure / toplamSure) * 100) : 0;
    if (yuzde > 100) yuzde = 100;
    if (yuzde < 0) yuzde = 0;

    string barColor = yuzde > 90 ? "bg-danger" : (yuzde > 70 ? "bg-warning" : "bg-success");

    string kartRengi = "border-success";
    string baslikRengi = "bg-success";
    string ikon = "fa-calendar-check";
    string durumMesaji = "Yasal süre içindesiniz.";

    if (Model.Status == "Tamamlandı")
    {
        kartRengi = "border-secondary";
        baslikRengi = "bg-secondary";
        ikon = "fa-flag-checkered";
        durumMesaji = "İşlem tamamlandı.";
    }
    else if (DateTime.Now > yasalBitisTarihi)
    {
        kartRengi = "border-danger";
        baslikRengi = "bg-danger";
        ikon = "fa-triangle-exclamation";
        durumMesaji = "YASAL SÜRE AŞILDI!";
    }
    else if (kalanIsGunu <= 5)
    {
        kartRengi = "border-warning";
        baslikRengi = "bg-warning text-dark";
        ikon = "fa-clock";
        durumMesaji = "Dikkat! Süre dolmak üzere.";
    }
}

<div class="container mt-4">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <div class="d-flex align-items-center gap-3">
            @if (User.IsInRole("Technician"))
            {
                <a asp-action="TechnicianPanel" class="btn btn-outline-secondary"><i class="fa-solid fa-arrow-left me-2"></i>Panele Dön</a>
            }
            else
            {
                <a asp-action="Index" class="btn btn-outline-secondary"><i class="fa-solid fa-arrow-left me-2"></i>Geri</a>
            }
            <h4 class="mb-0 fw-bold text-secondary">
                Fiş No: <span class="text-primary font-monospace">#@(Model.FisNo ?? "-")</span>
            </h4>
        </div>

        <div class="d-flex gap-2 align-items-center">
            <a asp-action="Print" asp-route-id="@Model.Id" target="_blank" class="btn btn-dark">
                <i class="fa-solid fa-print me-2"></i>Fiş Yazdır
            </a>
            <span class="badge @(Model.Status == "Tamamlandı" ? "bg-success" : "bg-info text-dark") p-2 fs-6">
                @Model.Status
            </span>
        </div>
    </div>

    <div class="row">
        <div class="col-md-8">

            <div class="card shadow-sm mb-4 border-0 border-top border-4 border-primary">
                <div class="card-header bg-white fw-bold text-uppercase small py-3 d-flex justify-content-between">
                    <span><i class="fa-solid fa-laptop me-2 text-primary"></i>Cihaz Bilgileri</span>
                    <span class="text-muted font-monospace">SN: @Model.SerialNumber</span>
                </div>
                <div class="card-body">
                    <h5 class="fw-bold text-dark">
                        @(Model.DeviceBrand != null ? Model.DeviceBrand.Name : "-") - @Model.DeviceModel
                    </h5>
                    <div class="mt-2">
                        @if (Model.IsWarranty)
                        {
                            <span class="badge bg-success bg-opacity-10 text-success border border-success px-3 py-2">
                                <i class="fa-solid fa-shield-check me-1"></i>GARANTİLİ CİHAZ
                            </span>
                        }
                        else
                        {
                            <span class="badge bg-secondary bg-opacity-10 text-secondary border px-3 py-2">
                                <i class="fa-solid fa-shield-xmark me-1"></i>GARANTİSİZ
                            </span>
                        }
                        <span class="badge bg-light text-dark border px-3 py-2 ms-2">
                            <i class="fa-solid fa-microchip me-1"></i>@(Model.DeviceType != null ? Model.DeviceType.Name : "Türü Belirtilmemiş")
                        </span>
                    </div>
                </div>
            </div>

            <div class="card shadow-sm mb-4 border-0">
                <div class="card-header bg-light fw-bold text-uppercase small py-3 text-danger">
                    <i class="fa-solid fa-triangle-exclamation me-2"></i>Arıza / Şikayet
                </div>
                <div class="card-body">
                    <p class="lead fs-6 mb-0 text-dark">@Model.ProblemDescription</p>
                </div>
            </div>

            <div class="card shadow-sm mb-4 border-info">
                <div class="card-header bg-info text-white fw-bold text-uppercase small py-3">
                    <i class="fa-solid fa-screwdriver-wrench me-2"></i>Teknisyen İşlemleri / Notları
                </div>
                <div class="card-body bg-light" style="max-height: 400px; overflow-y: auto;">
                    @if (!string.IsNullOrEmpty(Model.TechnicianNotes))
                    {
                        var notes = Model.TechnicianNotes.Split(new[] { '\n' }, StringSplitOptions.RemoveEmptyEntries).Reverse();

                        foreach (var note in notes)
                        {
                            <div class="card border-0 shadow-sm mb-2">
                                <div class="card-body p-3 d-flex align-items-start">
                                    <i class="fa-solid fa-pen-to-square text-info mt-1 me-3"></i>
                                    <div class="text-dark" style="font-size: 0.95rem; line-height: 1.5;">
                                        @note
                                    </div>
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="text-muted text-center small py-4">
                            <i class="fa-solid fa-clipboard-list mb-2 fs-3 opacity-25"></i><br>
                            Henüz işlem notu girilmedi.
                        </div>
                    }
                </div>
            </div>

            <div class="card shadow-sm mb-4 border-warning">
                <div class="card-header bg-warning bg-opacity-25 fw-bold text-dark text-uppercase small py-3">
                    <i class="fa-solid fa-boxes-stacked me-2"></i>Kullanılan Yedek Parçalar
                </div>
                <div class="card-body p-0">
                    @if (Model.UsedParts != null && Model.UsedParts.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-hover mb-0 small align-middle">
                                <thead class="bg-light text-secondary">
                                    <tr>
                                        <th class="ps-3 py-3">Parça Adı</th>
                                        <th class="text-center">Adet</th>
                                        <th class="text-end">Birim Fiyat</th>
                                        <th class="text-end pe-3">Tutar</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var part in Model.UsedParts)
                                    {
                                        <tr>
                                            <td class="ps-3 fw-bold text-dark">
                                                @(part.SparePart?.ProductName ?? "Silinmiş Parça")
                                            </td>
                                            <td class="text-center">
                                                <span class="badge bg-white text-dark border">@part.Quantity</span>
                                            </td>
                                            <td class="text-end">@part.Price.ToString("C2")</td>
                                            <td class="text-end pe-3 fw-bold text-primary">@part.TotalPrice.ToString("C2")</td>
                                        </tr>
                                    }
                                </tbody>
                                <tfoot class="bg-light border-top">
                                    <tr>
                                        <td colspan="3" class="text-end fw-bold text-muted py-3">Parça Toplamı:</td>
                                        <td class="text-end pe-3 fw-bold text-success fs-6">
                                            @Model.UsedParts.Sum(x => x.TotalPrice).ToString("C2")
                                        </td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="p-4 text-center text-muted">
                            <i class="fa-solid fa-box-open fs-3 mb-2 opacity-25"></i><br>
                            Bu işlemde henüz yedek parça kullanılmamıştır.
                        </div>
                    }
                </div>
            </div>

            @if (Model.TicketPhotos != null && Model.TicketPhotos.Any())
            {
                <div class="card shadow-sm mb-4 border-0">
                    <div class="card-header bg-dark text-white fw-bold text-uppercase small py-3">
                        <i class="fa-solid fa-images me-2"></i>Cihaz Fotoğrafları (@Model.TicketPhotos.Count)
                    </div>
                    <div class="card-body bg-light">
                        <div class="row g-3">
                            @foreach (var photo in Model.TicketPhotos)
                            {
                                <div class="col-6 col-md-3">
                                    <a href="@photo.Path" target="_blank" class="d-block position-relative group-hover">
                                        <img src="@photo.Path" class="img-fluid rounded shadow-sm border bg-white" style="height: 120px; width: 100%; object-fit: cover;" />
                                        <div class="position-absolute top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center bg-dark bg-opacity-50 opacity-0 hover-opacity-100 rounded transition-all">
                                            <i class="fa-solid fa-magnifying-glass text-white fs-4"></i>
                                        </div>
                                    </a>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            }
            else if (!string.IsNullOrEmpty(Model.PhotoPath))
            {
                <div class="card shadow-sm mb-4 border-0">
                    <div class="card-body text-center bg-light p-3 rounded">
                        <a href="@Model.PhotoPath" target="_blank">
                            <img src="@Model.PhotoPath" class="img-fluid rounded shadow-sm" style="max-height: 250px;" />
                        </a>
                    </div>
                </div>
            }
        </div>

        <div class="col-md-4">

            <div class="card shadow-sm border-0 mb-3">
                <div class="card-body text-center p-4">
                    <div class="bg-primary bg-opacity-10 text-primary p-3 rounded-circle d-inline-block mb-3">
                        <i class="fa-solid fa-user-circle fa-3x"></i>
                    </div>
                    <h5 class="fw-bold text-dark mb-1">@Model.Customer?.FirstName @Model.Customer?.LastName</h5>
                    <p class="text-muted small mb-3">
                        <i class="fa-solid fa-phone me-1"></i> @Model.Customer?.Phone
                    </p>
                    <div class="d-grid">
                        <a asp-controller="Customer" asp-action="Details" asp-route-id="@Model.CustomerId" class="btn btn-outline-primary btn-sm rounded-pill">
                            <i class="fa-solid fa-address-card me-1"></i>Profili Görüntüle
                        </a>
                    </div>
                </div>
            </div>

            <div class="card shadow-sm border-0 border-start border-4 border-info mb-3">
                <div class="card-body">
                    <h6 class="text-uppercase text-muted small fw-bold mb-3">
                        <i class="fa-solid fa-user-gear me-2"></i>Sorumlu Teknisyen
                    </h6>
                    @if (Model.Technician != null)
                    {
                        <div class="d-flex align-items-center">
                            <div class="bg-info text-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 45px; height: 45px;">
                                <span class="fw-bold fs-5">@Model.Technician.FullName.Substring(0, 1)</span>
                            </div>
                            <div>
                                <h6 class="fw-bold mb-0 text-dark">@Model.Technician.FullName</h6>
                                <span class="badge bg-info bg-opacity-10 text-info border border-info rounded-pill" style="font-size: 0.7rem;">Yetkili Personel</span>
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-secondary d-flex align-items-center p-2 mb-0 small">
                            <i class="fa-solid fa-user-clock me-2 fs-5"></i>
                            <div>
                                <strong>Atama Bekleniyor</strong><br />
                                Henüz bir teknisyen atanmadı.
                            </div>
                        </div>
                    }
                </div>
            </div>
            <div class="card shadow-sm @kartRengi mb-3">
                <div class="card-header @baslikRengi text-white fw-bold d-flex align-items-center justify-content-between">
                    <span><i class="fa-solid @ikon me-2"></i>Yasal Süre</span>
                    <span class="badge bg-white text-dark bg-opacity-75">21 İş Günü</span>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between border-bottom pb-2 mb-2">
                        <span class="text-muted small">Giriş Tarihi:</span>
                        <span class="fw-bold small">@Model.CreatedDate.ToString("dd.MM.yyyy")</span>
                    </div>
                    <div class="d-flex justify-content-between border-bottom pb-2 mb-3">
                        <span class="text-muted small">Son Teslim:</span>
                        <span class="fw-bold text-danger small">@yasalBitisTarihi.ToString("dd.MM.yyyy")</span>
                    </div>

                    @if (Model.Status != "Tamamlandı")
                    {
                        <div class="text-center mb-2">
                            @if (DateTime.Now <= yasalBitisTarihi)
                            {
                                <h2 class="fw-bold mb-0 display-6">@kalanIsGunu</h2>
                                <small class="text-muted text-uppercase fw-bold" style="font-size: 0.7rem;">İş Günü Kaldı</small>
                            }
                            else
                            {
                                <h4 class="fw-bold text-danger mb-0">SÜRE DOLDU</h4>
                            }
                        </div>
                        <div class="progress" style="height: 6px;">
                            <div class="progress-bar @barColor" role="progressbar" style="width: @yuzde%"></div>
                        </div>
                    }
                    <div class="mt-3 mb-0 text-center small fw-bold @(Model.Status == "Tamamlandı" ? "text-success" : "text-muted")">
                        @durumMesaji
                    </div>
                </div>
            </div>

            <div class="card shadow-sm border-warning">
                <div class="card-header bg-warning bg-opacity-25 fw-bold text-dark">
                    <i class="fa-solid fa-cash-register me-2"></i>Durum ve Ücret
                </div>
                <div class="card-body">
                    <form asp-action="ChangeStatus" method="post">
                        <input type="hidden" name="id" value="@Model.Id" />

                        <div class="mb-3">
                            <label class="form-label small fw-bold text-secondary">Toplam Servis Ücreti</label>
                            <div class="input-group">
                                <span class="input-group-text bg-white fw-bold">₺</span>
                                <input type="number" name="price" value="@(Model.TotalPrice.HasValue? Model.TotalPrice.Value.ToString("0.##", System.Globalization.CultureInfo.InvariantCulture) : "")" class="form-control fw-bold text-end" step="0.01" min="0" placeholder="0.00" />
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label small fw-bold text-secondary">İşlem Durumu</label>
                            <select name="status" class="form-select fw-bold">
                                <option value="Bekliyor" selected="@(Model.Status == "Bekliyor")">Bekliyor</option>
                                <option value="İşlemde" selected="@(Model.Status == "İşlemde")">İşlemde</option>
                                <option value="Parça Bekliyor" selected="@(Model.Status == "Parça Bekliyor")">Parça Bekliyor</option>
                                <option value="Tamamlandı" selected="@(Model.Status == "Tamamlandı")" class="text-success">Tamamlandı</option>
                                <option value="İptal" selected="@(Model.Status == "İptal")" class="text-danger">İptal</option>
                            </select>
                        </div>

                        <button class="btn btn-warning w-100 fw-bold shadow-sm" type="submit">
                            <i class="fa-solid fa-check-circle me-2"></i>Değişiklikleri Kaydet
                        </button>
                    </form>
                </div>
            </div>

            <div class="d-grid mt-3">
                <a asp-action="Edit" asp-route-id="@Model.Id" class="btn btn-outline-secondary btn-sm">
                    <i class="fa-solid fa-pen-to-square me-2"></i>Kaydı Düzenle
                </a>
            </div>
        </div>
    </div>
</div>

<style>
    .hover-opacity-100:hover {
        opacity: 1 !important;
    }

    .transition-all {
        transition: all 0.3s ease;
    }
</style>