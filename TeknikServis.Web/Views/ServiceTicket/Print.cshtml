@model TeknikServis.Core.Entities.ServiceTicket
@using TeknikServis.Web.Extensions
@using TeknikServis.Core.Interfaces
@using TeknikServis.Core.Entities
@inject IUnitOfWork UnitOfWork

@{
    Layout = null;
    // 1. Veritabanından Fiş Ayarlarını Çek
    var settings = (await UnitOfWork.Repository<ReceiptSetting>().GetAllAsync()).FirstOrDefault();
    // 2. Varsayılan Değerler
    string logoUrl = settings?.LogoPath;
    string headerText = settings?.HeaderText ?? "Müşteri Hizmetleri ve Teknik Destek Merkezi";

    // Varsayılan Şartlar
    string terms = settings?.ServiceTerms ?? "1. Teslim edilen cihazın sorumluluğu müşteriye aittir.\n" +
                   "2. Yasal servis süresi maksimum 20 iş günüdür.\n" +
                   "3. 90 gün içinde alınmayan cihazlardan sorumluluk kabul edilmez.\n" +
                   "4. Bu belge resmi evrak niteliğindedir.";
}

<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="utf-8" />
    <title>Servis Fişi - @(Model.FisNo ?? "Taslak")</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #000;
            font-size: 12px; /* Fontu biraz küçülttük ki sığsın */
            background-color: #f8f9fa;
        }

        .a4-container {
            max-width: 210mm;
            margin: 0 auto;
            background: white;
            padding: 10mm;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            min-height: 297mm;
        }

        .header-box {
            border-bottom: 2px solid #000;
            padding-bottom: 15px;
            margin-bottom: 15px;
        }

        .section-title {
            background-color: #eee;
            padding: 5px 10px;
            font-weight: bold;
            border-left: 5px solid #000;
            margin-bottom: 8px;
            text-transform: uppercase;
            font-size: 13px;
        }

        .info-table td {
            padding: 3px 6px;
            vertical-align: top;
            border-bottom: 1px solid #f0f0f0;
        }

        .label-col {
            font-weight: bold;
            color: #555;
            width: 140px; /* Genişliği biraz artırdık */
            text-align: right;
            padding-right: 15px !important;
            border-right: 1px solid #ddd;
            background-color: #fcfcfc;
        }

        .signature-box {
            border-top: 1px solid #000;
            width: 80%;
            margin: 0 auto;
            text-align: center;
            padding-top: 5px;
        }

        .device-photo {
            max-height: 120px;
            max-width: 100%;
            border: 1px solid #ddd;
            padding: 2px;
            border-radius: 4px;
        }

        /* YAZICI AYARLARI */
        @@media print {
            @@page {
                size: A4;
                margin: 5mm;
            }

            html, body {
                height: 100%;
                margin: 0 !important;
                padding: 0 !important;
                background: white;
                overflow: hidden;
            }

            .a4-container {
                box-shadow: none !important;
                margin: 0 !important;
                width: 100% !important;
                max-width: 100% !important;
                height: auto !important;
                padding: 0 !important;
                border: none !important;
            }

            .no-print, .btn, .toast {
                display: none !important;
            }

            .row, .col-6, .col-12 {
                page-break-inside: avoid;
            }
        }
    </style>
</head>
<body>

    <div class="no-print container py-3 mb-3 border-bottom bg-white sticky-top shadow-sm">
        <div class="d-flex justify-content-between align-items-center mw-100" style="max-width: 210mm; margin: 0 auto;">
            <a href="/ServiceTicket/Details/@Model.Id" class="btn btn-secondary">
                <i class="fa-solid fa-arrow-left me-2"></i>Geri Dön
            </a>

            <div class="d-flex gap-2">
                <button onclick="mailGonder(this)" class="btn btn-success">
                    <i class="fa-solid fa-envelope me-2"></i>Müşteriye Gönder
                </button>
                <button onclick="indirPDF()" class="btn btn-danger">
                    <i class="fa-solid fa-file-pdf me-2"></i>PDF İndir
                </button>
                <button onclick="window.print()" class="btn btn-primary">
                    <i class="fa-solid fa-print me-2"></i>Yazdır
                </button>
            </div>
        </div>
    </div>

    <div class="a4-container" id="fatura-alani">

        <div class="header-box d-flex justify-content-between align-items-end">
            <div>
                <small class="text-muted d-block mb-1 text-uppercase fw-bold">@User.GetBranchName()</small>

                <div class="d-flex align-items-center">
                    @if (!string.IsNullOrEmpty(logoUrl))
                    {
                        <img src="@logoUrl" alt="Firma Logosu" style="height: 55px; margin-right: 15px; object-fit: contain;" />
                    }
                    else
                    {
                        <i class="fa-solid fa-screwdriver-wrench text-dark fs-1 me-3"></i>
                    }

                    <div>
                        <h2 class="fw-bold mb-0" style="line-height: 1;">TeknikServis<span class="text-secondary">PRO</span></h2>
                        <div class="mt-1 small text-muted">@headerText</div>
                    </div>
                </div>
            </div>

            <div class="text-end">
                <h4 class="fw-bold mb-1">SERVİS FİŞİ</h4>
                <div id="qrcode" class="d-flex justify-content-end mb-2 mt-1"></div>
                <div class="fs-6 fw-bold font-monospace text-dark">#@(Model.FisNo ?? "YOK")</div>
                <small class="d-block text-muted">Kayıt: @Model.CreatedDate.ToString("dd.MM.yyyy HH:mm")</small>
            </div>
        </div>

        <div class="row">
            <div class="col-6">
                <div class="section-title">MÜŞTERİ BİLGİLERİ</div>
                <table class="info-table w-100">
                    <tr><td class="label-col">Ad Soyad</td><td>@Model.Customer?.FirstName @Model.Customer?.LastName</td></tr>
                    @if (!string.IsNullOrEmpty(Model.Customer?.CompanyName))
                    {
                        <tr><td class="label-col">Firma</td><td>@Model.Customer.CompanyName</td></tr>
                    }
                    <tr><td class="label-col">Telefon</td><td>@Model.Customer?.Phone</td></tr>
                    <tr><td class="label-col">E-Posta</td><td>@(Model.Customer?.Email ?? "Belirtilmedi")</td></tr>
                </table>
            </div>

            <div class="col-6">
                <div class="section-title">CİHAZ KİMLİĞİ</div>
                <table class="info-table w-100">
                    <tr>
                        <td class="label-col">Cihaz</td>
                        <td>
                            <strong>@(Model.DeviceType?.Name ?? "")</strong> - @(Model.DeviceBrand?.Name ?? "") @Model.DeviceModel
                        </td>
                    </tr>
                    <tr>
                        <td class="label-col">Seri No / IMEI</td>
                        <td class="font-monospace">@(string.IsNullOrEmpty(Model.SerialNumber) ? "Belirtilmedi" : Model.SerialNumber)</td>
                    </tr>
                    <tr>
                        <td class="label-col">Garanti Durumu</td>
                        <td>
                            @if (Model.IsWarranty)
                            {
                                <span class="fw-bold">GARANTİLİ</span>
                            }
                            else
                            {
                                <span>GARANTİ DIŞI</span>
                            }
                        </td>
                    </tr>
                    <tr>
                        <td class="label-col">Fatura Tarihi</td>
                        <td>@(Model.InvoiceDate.HasValue? Model.InvoiceDate.Value.ToString("dd.MM.yyyy") : "-")</td>
                    </tr>
                </table>
            </div>
        </div>

        <div class="row mt-3">
            <div class="col-12">
                <div class="section-title">FİZİKSEL DURUM & TESLİMAT BİLGİLERİ</div>
                <table class="info-table w-100">
                    <tr>
                        <td class="label-col">Aksesuarlar</td>
                        <td>@(string.IsNullOrEmpty(Model.Accessories) ? "YOK (Sadece Cihaz)" : Model.Accessories)</td>
                    </tr>
                    <tr>
                        <td class="label-col">Fiziksel Hasar</td>
                        <td>@(string.IsNullOrEmpty(Model.PhysicalDamage) ? "Hasar Kaydı Yok" : Model.PhysicalDamage)</td>
                    </tr>
                    <tr>
                        <td class="label-col">Mevcut Durum</td>
                        <td><strong class="text-uppercase border px-2 py-1 rounded bg-light">@Model.Status</strong></td>
                    </tr>
                </table>
            </div>
        </div>

        <hr class="my-4 text-secondary" />

        <div class="row">
            <div class="col-8">
                <div class="section-title">ARIZA / ŞİKAYET DETAYI</div>
                <div class="border p-3 rounded bg-light mb-3 text-dark" style="min-height: 80px; font-size: 13px;">
                    @Model.ProblemDescription
                </div>
            </div>
            <div class="col-4 text-center">
                @if (!string.IsNullOrEmpty(Model.PhotoPath))
                {
                    <div class="section-title text-center">CİHAZ GÖRSELİ</div>
                    <img src="@Model.PhotoPath" class="device-photo" alt="Cihaz Fotosu" />
                }
            </div>
        </div>

        <div class="row mt-2">
            <div class="col-12">
                <div class="section-title">TAHMİNİ / KESİN ÜCRET</div>
                <div class="d-flex justify-content-between align-items-center border p-3 bg-light">
                    <span>Hizmet Bedeli & Parça Tutarı (KDV Dahil):</span>
                    <span class="fs-4 fw-bold text-dark">
                        @(Model.TotalPrice.HasValue? Model.TotalPrice.Value.ToString("C2") : "Belirlenmedi")
                    </span>
                </div>
            </div>
        </div>

        <div class="mt-auto pt-4">
            <div class="row small text-muted mb-4">
                <div class="col-12 text-justify" style="font-size: 10px; line-height: 1.3;">
                    <strong>Servis Şartları:</strong>
                    <div class="ps-3 mt-1">
                        @if (!string.IsNullOrEmpty(terms))
                        {
                            foreach (var line in terms.Split('\n'))
                            {
                                if (!string.IsNullOrWhiteSpace(line))
                                {
                                    <div>@line</div>
                                }
                            }
                        }
                    </div>
                </div>
            </div>

            <div class="row mt-4">
                <div class="col-6 text-center">
                    <div class="mb-4 fw-bold">TESLİM ALAN (PERSONEL)</div>
                    <div class="signature-box">İmza / Kaşe</div>
                </div>
                <div class="col-6 text-center">
                    <div class="mb-4 fw-bold">TESLİM EDEN (MÜŞTERİ)</div>
                    <div class="signature-box">İmza</div>
                    <div class="small mt-1 text-muted">Cihazı eksiksiz ve yukarıdaki şartlarla teslim ettim/aldım.</div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // SAYFA YÜKLENDİĞİNDE QR KODU OLUŞTUR
        $(document).ready(function() {
            var fisNo = "@(Model.FisNo ?? "000000")";
            document.getElementById("qrcode").innerHTML = "";

            new QRCode(document.getElementById("qrcode"), {
                text: fisNo,
                width: 70,
                height: 70,
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });
        });

        function indirPDF() {
            var element = document.getElementById('fatura-alani');
            var opt = {
                margin: 0,
                filename: 'ServisFisi_@(Model.FisNo ?? "Dosya").pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            html2pdf().set(opt).from(element).save();
        }

        function mailGonder(btn) {
            var element = document.getElementById('fatura-alani');
            var originalHtml = $(btn).html();
            $(btn).prop('disabled', true).html('<i class="fa-solid fa-spinner fa-spin me-2"></i>Gönderiliyor...');
            var opt = {
                margin: 0,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            html2pdf().set(opt).from(element).outputPdf('blob').then(function (pdfBlob) {
                var formData = new FormData();
                formData.append('id', '@Model.Id');
                formData.append('pdfBlob', pdfBlob, 'ServisFisi.pdf');

                $.ajax({
                    url: '/ServiceTicket/SendTicketPdfMail',
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function (response) {
                        if (response.success) {
                            toastr.success(response.message);
                        } else {
                            toastr.error(response.message);
                        }
                    },
                    error: function () {
                        toastr.error('Sunucu hatası oluştu.');
                    },
                    complete: function () {
                        $(btn).prop('disabled', false).html(originalHtml);
                    }
                });
            });
        }
    </script>
</body>
</html>