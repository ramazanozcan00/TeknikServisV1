@using TeknikServis.Web.Extensions
@model IEnumerable<TeknikServis.Core.Entities.ServiceTicket>

@{
    ViewData["Title"] = "İşlerim";
    var completedTickets = ViewBag.CompletedTickets as IEnumerable<TeknikServis.Core.Entities.ServiceTicket>;
}

<div class="container mt-4">

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="fw-bold text-dark"><i class="fa-solid fa-screwdriver-wrench me-2 text-primary"></i>Teknisyen Paneli</h2>
    </div>

    <ul class="nav nav-pills mb-4" id="pills-tab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active fw-bold px-4" id="pills-active-tab" data-bs-toggle="pill" data-bs-target="#pills-active" type="button" role="tab">
                <i class="fa-solid fa-play me-2"></i>Aktif Görevler <span class="badge bg-white text-primary ms-2">@Model.Count()</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link fw-bold px-4" id="pills-completed-tab" data-bs-toggle="pill" data-bs-target="#pills-completed" type="button" role="tab">
                <i class="fa-solid fa-check-double me-2"></i>Tamamlananlar <span class="badge bg-white text-secondary ms-2">@completedTickets?.Count()</span>
            </button>
        </li>
    </ul>

    <div class="tab-content" id="pills-tabContent">

        <div class="tab-pane fade show active" id="pills-active" role="tabpanel">
            @if (!Model.Any())
            {
                <div class="text-center py-5 bg-light rounded">
                    <i class="fa-solid fa-mug-hot fs-1 text-secondary opacity-50 mb-3"></i>
                    <h5 class="text-muted">Harika!</h5>
                    <p class="text-muted small">Şu an üzerinizde bekleyen aktif bir iş yok.</p>
                </div>
            }
            else
            {
                <div class="row">
                    @foreach (var item in Model)
                    {
                        // Yasal Süre Hesabı (20 İş Günü)
                        var yasalBitis = item.CreatedDate.AddBusinessDays(20);
                        var kalanGun = yasalBitis.GetRemainingBusinessDays();

                        // Süre Rengi
                        string borderClass = kalanGun <= 3 ? "border-danger" : (kalanGun <= 7 ? "border-warning" : "border-info");
                        string bgClass = kalanGun <= 3 ? "bg-danger" : (kalanGun <= 7 ? "bg-warning text-dark" : "bg-info");

                        // Durum Rengi
                        string statusColor = "bg-secondary";
                        if (item.Status == "Bekliyor") { statusColor = "bg-warning text-dark"; }
                        else if (item.Status == "İşlemde") { statusColor = "bg-primary"; }
                        else if (item.Status == "Ödeme Bekleniyor") { statusColor = "bg-info text-dark"; } // Açık Mavi
                        else if (item.Status == "Ödeme Yapıldı") { statusColor = "bg-success"; } // Yeşil
                        else if (item.Status == "Parça Bekliyor") { statusColor = "bg-danger"; }
                        else if (item.Status == "İptal") { statusColor = "bg-dark"; }

                        <div class="col-md-6 col-lg-4 mb-4">
                            <div class="card h-100 shadow-sm border-0 border-top border-4 @borderClass">
                                <div class="card-body d-flex flex-column">

                                    <div class="d-flex justify-content-between align-items-start mb-3">
                                        <span class="badge bg-dark font-monospace">@item.FisNo</span>

                                        <div class="d-flex gap-1">
                                            <span class="badge @statusColor shadow-sm">@item.Status</span>
                                            <span class="badge @bgClass rounded-pill shadow-sm">@kalanGun Gün Kaldı</span>
                                        </div>
                                    </div>

                                    <h5 class="fw-bold text-dark mb-1">
                                        @(item.DeviceBrand != null ? item.DeviceBrand.Name : "-") @item.DeviceModel
                                    </h5>
                                    <div class="text-muted small mb-3">
                                        <i class="fa-solid fa-user me-1"></i> @item.Customer?.FirstName @item.Customer?.LastName
                                    </div>

                                    <div class="bg-light p-2 rounded border mb-3 flex-grow-1">
                                        <small class="text-uppercase fw-bold text-secondary" style="font-size: 10px;">Arıza / Şikayet</small>
                                        <p class="mb-0 small text-dark text-truncate-3">@item.ProblemDescription</p>
                                    </div>

                                    <div class="d-grid mt-auto">
                                        <a asp-action="ProcessTicket" asp-route-id="@item.Id" class="btn btn-outline-primary">
                                            <i class="fa-solid fa-play me-2"></i>İşlemi Başlat / Düzenle
                                        </a>
                                    </div>

                                    <div class="text-end mt-2">
                                        <small class="text-muted" style="font-size: 10px;">Giriş: @item.CreatedDate.ToString("dd.MM.yyyy")</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
        </div>

        <div class="tab-pane fade" id="pills-completed" role="tabpanel">
            @if (completedTickets == null || !completedTickets.Any())
            {
                <div class="text-center py-5 bg-light rounded">
                    <p class="text-muted">Henüz tamamlanmış bir işiniz bulunmuyor.</p>
                </div>
            }
            else
            {
                <div class="table-responsive bg-white shadow-sm rounded border">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light small text-muted text-uppercase">
                            <tr>
                                <th class="ps-3">Fiş No</th>
                                <th>Cihaz</th>
                                <th>Müşteri</th>
                                <th>Bitiş Tarihi</th>
                                <th>Tutar</th>
                                <th class="text-end pe-3">İşlem</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in completedTickets)
                            {
                                <tr>
                                    <td class="ps-3 font-monospace fw-bold text-dark">@item.FisNo</td>
                                    <td>@(item.DeviceBrand != null ? item.DeviceBrand.Name : "-") @item.DeviceModel</td>
                                    <td>@item.Customer?.FirstName @item.Customer?.LastName</td>

                                    <td class="text-muted small">
                                        @(item.UpdatedDate.HasValue? item.UpdatedDate.Value.ToString("dd.MM.yyyy HH:mm") : "-")
                                    </td>

                                    <td class="fw-bold text-success">
                                        @(item.TotalPrice.HasValue? item.TotalPrice.Value.ToString("C2") : "-")
                                    </td>
                                    <td class="text-end pe-3">
                                        <a asp-action="Details" asp-route-id="@item.Id" class="btn btn-sm btn-light border me-1" title="Detay Gör">
                                            <i class="fa-solid fa-eye"></i>
                                        </a>

                                        <a asp-action="ProcessTicket" asp-route-id="@item.Id" class="btn btn-sm btn-warning text-dark border" title="Fiyat/Not/Durum Düzenle">
                                            <i class="fa-solid fa-pen-to-square"></i>
                                        </a>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>

    </div>
</div>