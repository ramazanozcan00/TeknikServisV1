@model TeknikServis.Core.Entities.ServiceTicket

@{
    ViewData["Title"] = "Kaydı Düzenle";
    bool isAdmin = User.IsInRole("Admin");
}

<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />

<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-xl-9 col-lg-11">

            <form asp-action="Edit" method="post" enctype="multipart/form-data" class="needs-validation" novalidate>
                <input type="hidden" asp-for="Id" />
                <input type="hidden" asp-for="CustomerId" />

                <div class="card shadow border-0 rounded-3 overflow-hidden">

                    <div class="card-header bg-gradient bg-warning text-dark py-3 d-flex align-items-center justify-content-between">
                        <h5 class="mb-0 fw-bold">
                            <i class="fa-solid fa-file-pen me-2"></i>Servis Kaydını Düzenle
                        </h5>
                        <div class="d-flex align-items-center gap-2">
                            <span class="badge bg-dark text-white fs-6 font-monospace shadow-sm" title="Fiş Numarası">
                                <i class="fa-solid fa-hashtag me-1 text-warning"></i>@Model.FisNo
                            </span>
                            <span class="badge bg-light text-dark border" title="Kayıt Tarihi">
                                <i class="fa-solid fa-calendar-check me-1"></i>@Model.CreatedDate.ToString("dd.MM.yyyy")
                            </span>
                        </div>
                    </div>

                    <div class="card-body p-4 bg-light bg-opacity-10">

                        <div class="alert alert-light border-0 shadow-sm border-start border-4 border-primary d-flex align-items-center p-4 mb-4 bg-white">
                            <div class="bg-primary bg-opacity-10 text-primary rounded-circle p-3 me-3 d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                                <i class="fa-solid fa-address-card fs-4"></i>
                            </div>
                            <div class="flex-grow-1">
                                <small class="text-uppercase fw-bold text-muted" style="font-size: 0.75rem; letter-spacing: 0.5px;">Müşteri Bilgisi</small>

                                <div class="fs-5 fw-bold text-dark d-flex align-items-center flex-wrap gap-2">
                                    <span>@Model.Customer?.FirstName @Model.Customer?.LastName</span>

                                    @if (!string.IsNullOrEmpty(Model.Customer?.CompanyName))
                                    {
                                        <span class="badge bg-secondary bg-opacity-75 fs-6 fw-normal">
                                            <i class="fa-solid fa-building me-1"></i>@Model.Customer.CompanyName
                                        </span>
                                    }

                                    <a asp-controller="Customer" asp-action="Details" asp-route-id="@Model.CustomerId" target="_blank" class="text-decoration-none text-primary fs-6" title="Müşteri Profiline Git">
                                        <i class="fa-solid fa-square-arrow-up-right"></i>
                                    </a>
                                </div>

                                <div class="text-muted mt-1">
                                    <i class="fa-solid fa-mobile-screen-button me-1 text-success"></i> @Model.Customer?.Phone
                                </div>
                            </div>
                        </div>

                        <div class="bg-white p-4 rounded-3 shadow-sm mb-4 border-start border-4 border-info">
                            <h6 class="text-info fw-bold mb-3 border-bottom pb-2">
                                <i class="fa-solid fa-microchip me-2"></i>Cihaz Kimliği
                            </h6>
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="form-label fw-bold small text-secondary">Cihaz Türü</label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-light"><i class="fa-solid fa-desktop text-primary"></i></span>
                                        <select asp-for="DeviceTypeId" class="form-select" asp-items="ViewBag.DeviceTypes" required></select>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-bold small text-secondary">Marka</label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-light"><i class="fa-solid fa-certificate text-primary"></i></span>
                                        <select asp-for="DeviceBrandId" class="form-select" asp-items="ViewBag.DeviceBrands" required></select>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-bold small text-secondary">Model</label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-light"><i class="fa-solid fa-tag text-primary"></i></span>
                                        <input asp-for="DeviceModel" class="form-control" placeholder="Örn: iPhone 13" required />
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label fw-bold small text-secondary">Seri No (IMEI)</label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-light"><i class="fa-solid fa-barcode text-dark"></i></span>
                                        <input asp-for="SerialNumber" class="form-control font-monospace" placeholder="Seri numarası giriniz" required />
                                    </div>
                                </div>

                                <div class="col-md-3">
                                    <label class="form-label fw-bold small text-secondary">Fatura Tarihi</label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-light"><i class="fa-solid fa-receipt text-success"></i></span>
                                        <input asp-for="InvoiceDate" type="date" class="form-control" />
                                    </div>
                                </div>

                                <div class="col-md-3">
                                    <label class="form-label fw-bold small text-secondary">Garanti Durumu</label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-light"><i class="fa-solid fa-shield-halved text-warning"></i></span>
                                        <select asp-for="IsWarranty" class="form-select">
                                            <option value="false">Garantisiz</option>
                                            <option value="true">Garantili</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white p-4 rounded-3 shadow-sm mb-4 border-start border-4 border-warning">
                            <h6 class="text-warning fw-bold mb-3 border-bottom pb-2">
                                <i class="fa-solid fa-stethoscope me-2"></i>Fiziksel Kontrol ve Teslimat
                            </h6>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-bold small text-secondary">Teslim Alınan Aksesuarlar</label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-light"><i class="fa-solid fa-plug text-secondary"></i></span>
                                        <input asp-for="Accessories" class="form-control" placeholder="Örn: Şarj aleti, kılıf, çanta..." />
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold small text-secondary">Fiziksel Hasar Durumu</label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-light"><i class="fa-solid fa-house-crack text-danger"></i></span>
                                        <input asp-for="PhysicalDamage" class="form-control" placeholder="Örn: Ekran çatlak, kasa ezik..." />
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white p-4 rounded-3 shadow-sm mb-4 border-start border-4 border-danger">
                            <h6 class="text-danger fw-bold mb-3 border-bottom pb-2">
                                <i class="fa-solid fa-screwdriver-wrench me-2"></i>Servis Detayları
                            </h6>

                            <div class="mb-3">
                                <label class="form-label fw-bold small text-secondary">Arıza / Şikayet Açıklaması</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-light"><i class="fa-solid fa-comments text-danger"></i></span>
                                    <textarea asp-for="ProblemDescription" class="form-control" rows="3" placeholder="Müşterinin belirttiği arıza..." required></textarea>
                                </div>
                            </div>

                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-bold small text-secondary">Atanan Teknisyen</label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-light"><i class="fa-solid fa-user-gear text-dark"></i></span>
                                        @if (isAdmin)
                                        {
                                            <select asp-for="TechnicianId" class="form-select" asp-items="ViewBag.Technicians">
                                                <option value="">-- Havuza Bırak --</option>
                                            </select>
                                        }
                                        else
                                        {
                                            <select asp-for="TechnicianId" class="form-select bg-light" asp-items="ViewBag.Technicians" disabled>
                                                <option value="">-- Havuza Bırak --</option>
                                            </select>
                                            <input type="hidden" asp-for="TechnicianId" />
                                        }
                                    </div>
                                    @if (!isAdmin)
                                    {
                                        <div class="form-text small text-muted"><i class="fa-solid fa-lock me-1"></i>Teknisyen atamasını sadece yönetici yapabilir.</div>
                                    }
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label fw-bold small text-secondary">Teknisyen / Admin Notu</label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-light"><i class="fa-solid fa-clipboard-list text-info"></i></span>
                                        <textarea asp-for="TechnicianNotes" class="form-control bg-light" rows="2" readonly style="resize:none;"></textarea>
                                    </div>
                                    <div class="form-text small text-muted"><i class="fa-solid fa-lock me-1"></i>Notlar buradan değiştirilemez. İşlem sayfasını kullanın.</div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white p-4 rounded-3 shadow-sm mb-4 border-start border-4 border-secondary">
                            <h6 class="text-secondary fw-bold mb-3 border-bottom pb-2">
                                <i class="fa-solid fa-folder-open me-2"></i>Ek Dosyalar
                            </h6>

                            <div class="row g-3">
                                <div class="col-md-6 border-end">
                                    <label class="form-label fw-bold small text-secondary">Cihaz Fotoğrafı (Kapak)</label>
                                    <div class="mb-2">
                                        @if (!string.IsNullOrEmpty(Model.PhotoPath))
                                        {
                                            <a href="@Model.PhotoPath" target="_blank" class="btn btn-sm btn-outline-primary mb-2 w-100 text-start">
                                                <i class="fa-solid fa-image me-2"></i>Mevcut Fotoğrafı Görüntüle
                                            </a>
                                        }
                                        else
                                        {
                                            <span class="badge bg-secondary mb-2 d-block w-100 text-start py-2"><i class="fa-solid fa-ban me-1"></i>Fotoğraf Yok</span>
                                        }
                                    </div>
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-text"><i class="fa-solid fa-camera"></i></span>
                                        <input type="file" name="photo" class="form-control" accept="image/*" />
                                    </div>
                                    <div class="form-text small">Değiştirmek için yeni dosya seçin.</div>
                                </div>

                                <div class="col-md-6 ps-md-4">
                                    <label class="form-label fw-bold small text-secondary">Döküman / Fatura (PDF)</label>
                                    <div class="mb-2">
                                        @if (!string.IsNullOrEmpty(Model.PdfPath))
                                        {
                                            <a href="@Model.PdfPath" target="_blank" class="btn btn-sm btn-outline-danger mb-2 w-100 text-start">
                                                <i class="fa-solid fa-file-pdf me-2"></i>Mevcut PDF'i Aç
                                            </a>
                                        }
                                        else
                                        {
                                            <span class="badge bg-secondary mb-2 d-block w-100 text-start py-2"><i class="fa-solid fa-ban me-1"></i>Döküman Yok</span>
                                        }
                                    </div>
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-text"><i class="fa-solid fa-file-invoice"></i></span>
                                        <input type="file" name="pdfFile" class="form-control" accept=".pdf" />
                                    </div>
                                    <div class="form-text small">Fatura veya garanti belgesi (Sadece PDF).</div>
                                </div>
                            </div>
                        </div>

                    </div>

                    <div class="card-footer bg-light py-3 px-4 d-flex justify-content-end gap-2 border-top">
                        <a asp-action="Details" asp-route-id="@Model.Id" class="btn btn-outline-secondary px-4 fw-bold shadow-sm">
                            <i class="fa-solid fa-arrow-left me-2"></i>İptal
                        </a>
                        <button type="submit" class="btn btn-warning px-5 fw-bold shadow-sm">
                            <i class="fa-solid fa-floppy-disk me-2"></i>Değişiklikleri Kaydet
                        </button>
                    </div>

                </div>
            </form>

        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
        // Select2 vb. scriptler buraya eklenebilir
    </script>
}