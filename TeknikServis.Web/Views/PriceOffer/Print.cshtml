@* Dosya: TeknikServis.Web/Views/PriceOffer/Print.cshtml *@
@model TeknikServis.Core.Entities.PriceOffer

@{
    Layout = null;
    var branchInfo = ViewBag.BranchInfo as TeknikServis.Core.Entities.BranchInfo;
}

<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="utf-8" />
    <title>Fiyat Teklifi - @Model.DocumentNo</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        .invoice-box {
            max-width: 800px;
            margin: auto;
            padding: 30px;
            border: 1px solid #eee;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.15);
            font-size: 14px;
            line-height: 22px;
            color: #555;
            background: #fff;
        }

        .invoice-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 20px;
        }

        .company-info {
            text-align: right;
            font-size: 12px;
        }

        /* Müşteri Bilgileri Alanı Stilleri */
        .client-section {
            padding: 15px;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .client-label {
            font-size: 11px;
            font-weight: bold;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }

        .client-name {
            color: #212529;
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 10px;
        }

        /* Yazdırma anında butonları gizle */
        @@media print {
            .no-print

        {
            display: none !important;
        }

        .invoice-box {
            box-shadow: none;
            border: 0;
        }

        body {
            background: #fff;
        }

        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" />
</head>
<body>

    <div class="no-print text-center mb-4 d-flex justify-content-center gap-2">
        <button onclick="window.print()" class="btn btn-secondary">
            <i class="fa fa-print"></i> Yazdır
        </button>

        <button onclick="downloadPdf()" class="btn btn-success">
            <i class="fa fa-file-pdf"></i> PDF İndir
        </button>

        <button onclick="sendMail()" id="btnSendMail" class="btn btn-primary">
            <span id="btnText"><i class="fa fa-envelope"></i> E-Posta Gönder (PDF)</span>
            <span id="btnSpinner" class="spinner-border spinner-border-sm d-none" role="status"></span>
        </button>

        <a href="/PriceOffer/Index" class="btn btn-light border">Geri Dön</a>
    </div>

    <div class="invoice-box" id="print-area">

        <div class="invoice-header border-bottom pb-3">
            <div>
                <h3 class="fw-bold text-primary mb-0">FİYAT TEKLİFİ</h3>
                <div class="text-muted fw-bold mt-1">Teklif No: @Model.DocumentNo</div>
                <div class="small text-muted">Tarih: @Model.OfferDate.ToShortDateString()</div>
            </div>

            <div class="company-info">
                @if (branchInfo != null)
                {
                    <h5 class="fw-bold text-dark mb-1">@branchInfo.CompanyName</h5>

                    @if (!string.IsNullOrEmpty(branchInfo.Address))
                    {
                        <div>@branchInfo.Address</div>
                    }

                    <div>
                        @if (!string.IsNullOrEmpty(branchInfo.Phone))
                        {
                            <span>Tel: @branchInfo.Phone</span>
                        }
                        @if (!string.IsNullOrEmpty(branchInfo.Phone) && !string.IsNullOrEmpty(branchInfo.Email))
                        {
                            <span> | </span>
                        }
                        @if (!string.IsNullOrEmpty(branchInfo.Email))
                        {
                            <span>@branchInfo.Email</span>
                        }
                    </div>

                    @if (!string.IsNullOrEmpty(branchInfo.TaxOffice) && !string.IsNullOrEmpty(branchInfo.TaxNumber))
                    {
                        <div><strong>VD:</strong> @branchInfo.TaxOffice <strong>VN:</strong> @branchInfo.TaxNumber</div>
                    }

                    @if (branchInfo.GetType().GetProperty("Website") != null)
                    {
                        var web = branchInfo.GetType().GetProperty("Website")?.GetValue(branchInfo)?.ToString();
                        if (!string.IsNullOrEmpty(web))
                        {
                            <div>@web</div>
                        }
                    }

                    @if (branchInfo.GetType().GetProperty("Iban") != null)
                    {
                        var iban = branchInfo.GetType().GetProperty("Iban")?.GetValue(branchInfo)?.ToString();
                        var bank = branchInfo.GetType().GetProperty("BankName")?.GetValue(branchInfo)?.ToString();
                        if (!string.IsNullOrEmpty(iban))
                        {
                            <div class="mt-1 p-1 bg-light border rounded d-inline-block">
                                <strong>@bank IBAN:</strong> @iban
                            </div>
                        }
                    }
                }
                else
                {
                    <h5 class="mb-0">Teknik Servis</h5>
                }
            </div>
        </div>

        <div class="client-section">
            <div class="client-label" style="border-bottom: 1px solid #dee2e6; margin-bottom: 10px; padding-bottom: 5px;">
                SAYIN / FİRMA BİLGİLERİ
            </div>

            <h3 class="client-name mb-3">
                @if (!string.IsNullOrEmpty(Model.Customer.CompanyName))
                {
                    @Model.Customer.CompanyName.ToUpper()
                    <div style="font-size: 0.9rem; font-weight: normal; color: #555; margin-top: 2px;">
                        Yetkili: @Model.Customer.FirstName @Model.Customer.LastName
                    </div>
                }
                else
                {
                    @($"{Model.Customer.FirstName} {Model.Customer.LastName}".ToUpper())
                }
            </h3>

            <div class="row g-1 text-muted" style="font-size: 0.95rem;">

                @if (!string.IsNullOrEmpty(Model.Customer.Address) || !string.IsNullOrEmpty(Model.Customer.City))
                {
                    <div class="col-3 fw-bold">Adres:</div>
                    <div class="col-9">
                        @Model.Customer.Address
                        @if (!string.IsNullOrEmpty(Model.Customer.District) || !string.IsNullOrEmpty(Model.Customer.City))
                        {
                            <br />
                            <span class="text-dark">@Model.Customer.District / @Model.Customer.City</span>
                        }
                    </div>
                }

                @if (!string.IsNullOrEmpty(Model.Customer.Phone))
                {
                    <div class="col-3 fw-bold">Telefon:</div>
                    <div class="col-9">
                        @Model.Customer.Phone
                        @if (!string.IsNullOrEmpty(Model.Customer.Phone2))
                        {
                            <span class="ms-2">/ @Model.Customer.Phone2</span>
                        }
                    </div>
                }

                @if (!string.IsNullOrEmpty(Model.Customer.Email))
                {
                    <div class="col-3 fw-bold">E-Posta:</div>
                    <div class="col-9">@Model.Customer.Email</div>
                }

                @if (!string.IsNullOrEmpty(Model.Customer.TaxNumber))
                {
                    <div class="col-3 fw-bold">Vergi Dairesi:</div>
                    <div class="col-9">
                        @Model.Customer.TaxOffice
                        <span class="ms-3 fw-bold">VN:</span> @Model.Customer.TaxNumber
                    </div>
                }
                else if (!string.IsNullOrEmpty(Model.Customer.TCNo))
                {
                    <div class="col-3 fw-bold">TC Kimlik No:</div>
                    <div class="col-9">@Model.Customer.TCNo</div>
                }
            </div>
        </div>

        <table class="table table-striped table-bordered mt-3 align-middle">
            <thead class="table-light">
                <tr style="font-size: 13px;">
                    <th>Açıklama / Ürün / Hizmet</th>
                    <th class="text-center" width="80">Miktar</th>
                    <th class="text-end" width="130">Birim Fiyat</th>
                    <th class="text-end" width="130">Tutar</th>
                </tr>
            </thead>
            <tbody>
                @if (Model.Items != null)
                {
                    foreach (var item in Model.Items)
                    {
                        <tr>
                            <td>
                                <div class="fw-bold">@item.ProductName</div>
                            </td>
                            <td class="text-center">@item.Quantity</td>
                            <td class="text-end">@item.UnitPrice.ToString("N2") ₺</td>
                            <td class="text-end fw-bold">@item.TotalPrice.ToString("N2") ₺</td>
                        </tr>
                    }
                }
            </tbody>
            <tfoot>
                <tr>
                    <td colspan="3" class="text-end fw-bold pt-3 fs-5">GENEL TOPLAM:</td>
                    <td class="text-end fw-bold text-primary pt-3 fs-5">@Model.TotalAmount.ToString("N2") ₺</td>
                </tr>
            </tfoot>
        </table>

        <div class="mt-5 pt-3 border-top">
            @if (!string.IsNullOrEmpty(Model.Notes))
            {
                <div class="mb-4">
                    <strong class="text-dark d-block mb-1">Notlar / Şartlar:</strong>
                    <div class="text-muted small">@Html.Raw(Model.Notes.Replace("\n", "<br>"))</div>
                </div>
            }

            <div class="row mt-5 pt-4">
                <div class="col-6 text-center">
                    <div class="mb-4 small text-muted">Teklifi Onaylıyorum</div>
                    <div class="border-top w-75 mx-auto pt-2 fw-bold">Müşteri İmza / Kaşe</div>
                </div>
                <div class="col-6 text-center">
                    <div class="mb-4 small text-muted">Düzenleyen</div>
                    <div class="border-top w-75 mx-auto pt-2 fw-bold">
                        @ViewBag.PersonnelName
                        <br><span class="small fw-normal text-muted">Firma Yetkilisi</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script>
        // PDF Ayarları (Ortak Kullanım)
        function getPdfOptions() {
            return {
                margin:       [10, 10, 10, 10],
                filename:     'Teklif_{@Model.DocumentNo}.pdf',
                image:        { type: 'jpeg', quality: 0.98 },
                html2canvas:  { scale: 2, useCORS: true },
                jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
        }

        // --- 1. PDF İNDİR ---
        function downloadPdf() {
            var element = document.getElementById('print-area');
            html2pdf().set(getPdfOptions()).from(element).save();
        }

        // --- 2. PDF MAİL GÖNDER ---
        function sendMail() {
            var btn = $('#btnSendMail');
            var spinner = $('#btnSpinner');
            var txt = $('#btnText');

            btn.prop('disabled', true);
            spinner.removeClass('d-none');
            txt.text(' PDF Oluşturuluyor...');

            var element = document.getElementById('print-area');

            html2pdf().set(getPdfOptions()).from(element).output('blob').then(function(pdfBlob) {

                txt.text(' Gönderiliyor...');

                var formData = new FormData();
                formData.append('id', '@Model.Id');
                formData.append('pdfBlob', pdfBlob, 'Teklif.pdf');

                $.ajax({
                    url: '/PriceOffer/SendOfferMail',
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(response) {
                        if (response.success) {
                            toastr.success(response.message);
                        } else {
                            toastr.error(response.message);
                        }
                    },
                    error: function() {
                        toastr.error('Sunucu ile iletişim hatası.');
                    },
                    complete: function() {
                        btn.prop('disabled', false);
                        spinner.addClass('d-none');
                        txt.html('<i class="fa fa-envelope"></i> E-Posta Gönder (PDF)');
                    }
                });

            }).catch(function(err) {
                console.error(err);
                toastr.error('PDF oluşturulurken hata oluştu.');
                btn.prop('disabled', false);
                spinner.addClass('d-none');
                txt.html('<i class="fa fa-envelope"></i> E-Posta Gönder (PDF)');
            });
        }
    </script>
</body>
</html>