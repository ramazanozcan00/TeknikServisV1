@model TeknikServis.Web.Models.PriceOfferViewModel

@{
    ViewData["Title"] = "Yeni Fiyat Teklifi";
}

<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />

<div class="container-fluid py-4">
    <form asp-action="Create" id="offerForm">
        <div asp-validation-summary="All" class="alert alert-danger mb-3" style="display:none;"></div>

        <input type="hidden" asp-for="CustomerId" id="CustomerId" />

        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="text-primary"><i class="fa-solid fa-file-invoice me-2"></i>Yeni Fiyat Teklifi</h2>
            <div>
                <a asp-action="Index" class="btn btn-outline-secondary me-2"><i class="fa-solid fa-arrow-left"></i> Vazgeç</a>
                <button type="submit" class="btn btn-success btn-lg"><i class="fa-solid fa-check"></i> Kaydet</button>
            </div>
        </div>

        <div class="row">
            <div class="col-md-4">
                <div class="card shadow-sm mb-4 border-0 border-top border-4 border-primary">
                    <div class="card-body">
                        <h6 class="card-title text-muted mb-3">Belge Bilgileri</h6>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Şube</label>
                            <select asp-for="BranchId" class="form-select" disabled>
                                @foreach (var item in Model.Branches)
                                {
                                    <option value="@item.Id">@item.BranchName</option>
                                }
                            </select>
                            <input type="hidden" id="HiddenBranchId" name="BranchId" value="@Model.BranchId" />
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Belge No</label>
                            <input asp-for="DocumentNo" class="form-control bg-light" readonly />
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Tarih</label>
                            <input asp-for="OfferDate" type="date" class="form-control" />
                        </div>
                    </div>
                </div>

                <div class="card shadow-sm mb-4 border-0">
                    <div class="card-body">
                        <h6 class="card-title text-muted mb-3">Cari Seçimi</h6>

                        <div class="mb-3">
                            <label class="small text-muted fw-bold">Bireysel Müşteri</label>
                            <div class="input-group">
                                <span class="input-group-text bg-white"><i class="fa-solid fa-user"></i></span>
                                <select id="selectIndividual" class="form-select select2-individual">
                                    <option value="">Yükleniyor...</option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-0">
                            <label class="small text-muted fw-bold">Kayıtlı Firma (Kurumsal)</label>
                            <div class="input-group">
                                <span class="input-group-text bg-white"><i class="fa-solid fa-building"></i></span>
                                <select id="selectCompany" class="form-select select2-company">
                                    <option value="">Yükleniyor...</option>
                                </select>
                            </div>
                        </div>

                    </div>
                </div>

                <div class="card shadow-sm mb-4 border-0">
                    <div class="card-header bg-light">
                        <h6 class="m-0 text-dark"><i class="fa-solid fa-building me-2"></i>Firma Bilgileri (Gönderen)</h6>
                    </div>
                    <div class="card-body small">
                        <div class="mb-2">
                            <strong class="d-block text-muted">Ünvan:</strong>
                            <span id="lblCompanyTitle" class="fw-bold text-primary">Yükleniyor...</span>
                        </div>
                        <div class="mb-2">
                            <strong class="d-block text-muted">Telefon & Adres:</strong>
                            <span id="lblCompanyInfo">-</span>
                        </div>
                        <div class="mb-2">
                            <strong class="d-block text-muted">Vergi Dairesi / No:</strong>
                            <span id="lblCompanyTax">-</span>
                        </div>
                    </div>
                </div>

                <div class="card shadow-sm mb-4 border-0">
                    <div class="card-header bg-light">
                        <h6 class="m-0 text-dark"><i class="fa-solid fa-address-card me-2"></i>Seçilen Cari Detayları</h6>
                    </div>
                    <div class="card-body small">
                        <div class="mb-2">
                            <strong class="d-block text-muted">Ünvan / Ad Soyad:</strong>
                            <span id="lblCustTitle" class="fw-bold text-primary">-</span>
                        </div>
                        <div>
                            <strong class="d-block text-muted">Telefon & Adres:</strong>
                            <span id="lblCustInfo" class="text-muted">-</span>
                        </div>
                    </div>
                </div>

                <div class="card shadow-sm border-0">
                    <div class="card-body">
                        <h6 class="card-title text-muted">Notlar</h6>
                        <textarea asp-for="Notes" class="form-control" rows="3" placeholder="Teklif notları..."></textarea>
                    </div>
                </div>
            </div>

            <div class="col-md-8">
                <div class="card shadow-sm border-0 h-100">
                    <div class="card-header bg-white py-3">
                        <h5 class="m-0 text-primary"><i class="fa-solid fa-box-open me-2"></i>Ürün/Hizmet Kalemleri</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="p-3 bg-light border-bottom">
                            <div class="row g-2 align-items-end">
                                <div class="col-md-4">
                                    <label class="small text-muted">Stoktan Ürün Seç</label>
                                    <select id="productSelect" class="form-select select2-product">
                                        <option value="" data-price="0">Yükleniyor...</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="small text-muted">Ürün Adı (Manuel)</label>
                                    <input type="text" id="manualName" class="form-control" placeholder="Ürün adı" />
                                </div>
                                <div class="col-md-2">
                                    <label class="small text-muted">Miktar</label>
                                    <input type="number" id="qty" class="form-control" value="1" min="1" />
                                </div>
                                <div class="col-md-2">
                                    <label class="small text-muted">Birim Fiyat</label>
                                    <input type="number" id="price" class="form-control" value="0" step="0.01" />
                                </div>
                                <div class="col-md-1">
                                    <button type="button" id="btnAddRow" class="btn btn-primary w-100"><i class="fa-solid fa-plus"></i></button>
                                </div>
                            </div>
                        </div>

                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0" id="itemsTable">
                                <thead class="table-light">
                                    <tr>
                                        <th>Ürün Adı</th>
                                        <th width="100" class="text-center">Miktar</th>
                                        <th width="150" class="text-end">Birim Fiyat</th>
                                        <th width="150" class="text-end">Tutar</th>
                                        <th width="50"></th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                                <tfoot class="table-light fw-bold">
                                    <tr>
                                        <td colspan="3" class="text-end">GENEL TOPLAM:</td>
                                        <td class="text-end text-primary fs-5" id="grandTotal">0.00 ₺</td>
                                        <td></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <input type="hidden" asp-for="BranchId" />
        <input type="hidden" asp-for="DocumentNo" />

        <input type="hidden" asp-for="ItemsJson" id="ItemsJson" />
    </form>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script>
        $(document).ready(function() {
            // Select2 Ayarları
            var indSelect = $('.select2-individual').select2({ theme: 'bootstrap-5', placeholder: 'Bireysel Müşteri Seç...', allowClear: true });
            var comSelect = $('.select2-company').select2({ theme: 'bootstrap-5', placeholder: 'Kayıtlı Firma Seç...', allowClear: true });
            var prodSelect = $('.select2-product').select2({ theme: 'bootstrap-5', placeholder: 'Ürün Ara...', allowClear: true });

            // --- 1. SAYFA YÜKLENDİĞİNDE VERİLERİ ÇEK ---
            var currentBranchId = $('#HiddenBranchId').val();

            if(currentBranchId) {
                $.get('/PriceOffer/GetBranchData?branchId=' + currentBranchId, function(data) {

                    // A. GÖNDEREN FİRMA BİLGİLERİ
                    if(data.info) {
                        $('#lblCompanyTitle').text(data.info.title);
                        var contact = (data.info.phone || '-') + ' / ' + (data.info.address || '-');
                        $('#lblCompanyInfo').text(contact);
                        $('#lblCompanyTax').text(data.info.tax);
                    }

                    // B. BİREYSEL MÜŞTERİLERİ DOLDUR
                    if(data.individuals) {
                        indSelect.empty().append(new Option('Seçiniz...', '', true, true));
                        $.each(data.individuals, function(i, item) {
                            indSelect.append(new Option(item.text, item.id, false, false));
                        });
                        indSelect.val(null).trigger('change');
                    }

                    // C. KURUMSAL FİRMALARI DOLDUR
                    if(data.companies) {
                        comSelect.empty().append(new Option('Seçiniz...', '', true, true));
                        $.each(data.companies, function(i, item) {
                            comSelect.append(new Option(item.text, item.id, false, false));
                        });
                        comSelect.val(null).trigger('change');
                    }

                    // D. ÜRÜNLERİ DOLDUR
                    if(data.parts) {
                        prodSelect.empty().append(new Option('Manuel Giriş / Seçiniz', '', true, true));
                        $.each(data.parts, function(i, item) {
                            var text = item.productName + ' (Stok: ' + item.quantity + ')';
                            var newOption = new Option(text, item.id, false, false);
                            $(newOption).attr('data-price', item.salesPrice);
                            $(newOption).attr('data-name', item.productName);
                            prodSelect.append(newOption);
                        });
                        prodSelect.val(null).trigger('change');
                    }

                });
            }

            // --- 2. KARŞILIKLI KİLİTLEME MANTIĞI (MUTUAL EXCLUSION) ---

            // Bireysel Seçilirse -> Firmayı Temizle
            $('#selectIndividual').on('change', function() {
                var val = $(this).val();
                if(val) {
                    // Firmayı temizle (Sonsuz döngüyü önlemek için kontrol etmeye gerek yok, null atamak güvenlidir)
                    $('#selectCompany').val(null).trigger('change.select2');

                    // Gizli Inputu Güncelle
                    $('#CustomerId').val(val).trigger('change');
                } else {
                    // Eğer boşaltıldıysa ve diğer tarafta da seçim yoksa ID'yi sıfırla
                    if(!$('#selectCompany').val()) $('#CustomerId').val('').trigger('change');
                }
            });

            // Firma Seçilirse -> Bireyseli Temizle
            $('#selectCompany').on('change', function() {
                var val = $(this).val();
                if(val) {
                    // Bireyseli temizle
                    $('#selectIndividual').val(null).trigger('change.select2');

                    // Gizli Inputu Güncelle
                    $('#CustomerId').val(val).trigger('change');
                } else {
                    // Eğer boşaltıldıysa ve diğer tarafta da seçim yoksa ID'yi sıfırla
                    if(!$('#selectIndividual').val()) $('#CustomerId').val('').trigger('change');
                }
            });

            // --- 3. GİZLİ INPUT DEĞİŞTİĞİNDE DETAYLARI GETİR ---
            $('#CustomerId').change(function() {
                var custId = $(this).val();

                // Kutuları temizle
                $('#lblCustTitle').text('-');
                $('#lblCustInfo').text('-');

                if(!custId) return;

                $.get('/PriceOffer/GetCustomerData?customerId=' + custId, function(data) {
                    if(data) {
                        $('#lblCustTitle').text(data.title);
                        var infoText = (data.phone || '-') + ' / ' + (data.address || '-');
                        $('#lblCustInfo').text(infoText);
                    }
                });
            });

            // --- 4. ÜRÜN SEÇİMİ VE TABLO İŞLEMLERİ (Standart) ---
            $('#productSelect').on('select2:select', function (e) {
                var selectedOption = $(this).find(':selected');
                var price = parseFloat(selectedOption.attr('data-price')) || 0;
                var name = selectedOption.attr('data-name') || "";
                $('#price').val(price);
                $('#manualName').val(name);
            });
            $('#productSelect').on('select2:clear', function (e) { $('#price').val(0); $('#manualName').val(''); });

            $('#btnAddRow').click(function() {
                var prodId = $('#productSelect').val() || "";
                var prodName = $('#manualName').val();
                var qty = parseFloat($('#qty').val()) || 1;
                var price = parseFloat($('#price').val()) || 0;
                var total = qty * price;

                if(prodName === "") { alert("Lütfen ürün seçin veya adını yazın."); return; }

                var row = `
                    <tr data-id="${prodId}" data-qty="${qty}" data-price="${price}" data-name="${prodName}">
                        <td>${prodName}</td>
                        <td class="text-center">${qty}</td>
                        <td class="text-end">${price.toFixed(2)} ₺</td>
                        <td class="text-end row-total">${total.toFixed(2)} ₺</td>
                        <td><button type="button" class="btn btn-sm btn-outline-danger btn-remove"><i class="fa-solid fa-trash"></i></button></td>
                    </tr>`;
                $('#itemsTable tbody').append(row);
                calculateGrandTotal();

                $('#manualName').val('');
                $('#qty').val(1);
                $('#productSelect').val(null).trigger('change');
                $('#price').val(0);
            });

            $(document).on('click', '.btn-remove', function() { $(this).closest('tr').remove(); calculateGrandTotal(); });

            function calculateGrandTotal() {
                var total = 0;
                $('.row-total').each(function() {
                    var val = parseFloat($(this).text().replace(' ₺', ''));
                    if(!isNaN(val)) total += val;
                });
                $('#grandTotal').text(total.toFixed(2) + " ₺");
            }

            $('#offerForm').submit(function() {
                // CustomerId kontrolü
                if(!$('#CustomerId').val()) {
                    alert("Lütfen bir müşteri veya firma seçiniz.");
                    return false;
                }

                var items = [];
                $('#itemsTable tbody tr').each(function() {
                    var row = $(this);
                    var pid = row.attr('data-id');
                    if(pid === "" || pid === "undefined" || pid === "null") pid = null;
                    items.push({ ProductId: pid, ProductName: row.attr('data-name'), Quantity: row.attr('data-qty'), Price: row.attr('data-price') });
                });
                // DÜZELTME BURADA: itemsJson -> ItemsJson (Input ID'si ile eşleşmeli)
                $('#ItemsJson').val(JSON.stringify(items));
            });
        });
    </script>
}