@model TeknikServis.Web.Models.PriceOfferViewModel

@{
    ViewData["Title"] = "Teklifi Düzenle";
}

<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />

<div class="container-fluid py-4">
    <form asp-action="Edit" id="offerForm" method="post">
        <input type="hidden" asp-for="Id" />
        <input type="hidden" asp-for="ItemsJson" id="ItemsJson" />

        @if (!ViewData.ModelState.IsValid)
        {
            <div class="alert alert-danger mb-3">
                <h6 class="alert-heading"><i class="fa-solid fa-circle-exclamation me-2"></i>Lütfen aşağıdaki hataları düzeltin:</h6>
                <div asp-validation-summary="All" class="text-danger small mb-0"></div>
            </div>
        }

        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="text-primary"><i class="fa-solid fa-pen-to-square me-2"></i>Teklifi Düzenle</h2>
            <div>
                <a asp-action="Index" class="btn btn-outline-secondary me-2"><i class="fa-solid fa-arrow-left"></i> Vazgeç</a>
                <button type="button" id="btnSave" class="btn btn-primary btn-lg"><i class="fa-solid fa-save"></i> Değişiklikleri Kaydet</button>
            </div>
        </div>

        <div class="row">
            <div class="col-md-4">
                <div class="card shadow-sm mb-4 border-0 border-top border-4 border-primary">
                    <div class="card-body">
                        <h6 class="card-title text-muted mb-3">Belge Bilgileri</h6>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Şube</label>
                            <select asp-for="BranchId" class="form-select" disabled>
                                @foreach (var item in Model.Branches)
                                {
                                    <option value="@item.Id">@item.BranchName</option>
                                }
                            </select>
                            <input type="hidden" name="BranchId" value="@Model.BranchId" />
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Belge No</label>
                            <input asp-for="DocumentNo" class="form-control bg-light" readonly />
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Tarih</label>
                            <input asp-for="OfferDate" type="date" class="form-control" />
                        </div>
                    </div>
                </div>

                <div class="card shadow-sm mb-4 border-0">
                    <div class="card-body">
                        <h6 class="card-title text-muted mb-3">Müşteri Seçimi</h6>
                        <select asp-for="CustomerId" asp-items="Model.CustomerList" class="form-select select2" required>
                            <option value="">Cari Seçiniz...</option>
                        </select>
                        <span asp-validation-for="CustomerId" class="text-danger small"></span>
                    </div>
                </div>

                <div class="card shadow-sm border-0">
                    <div class="card-body">
                        <h6 class="card-title text-muted">Notlar</h6>
                        <textarea asp-for="Notes" class="form-control" rows="3"></textarea>
                    </div>
                </div>
            </div>

            <div class="col-md-8">
                <div class="card shadow-sm border-0 h-100">
                    <div class="card-header bg-white py-3">
                        <h5 class="m-0 text-primary"><i class="fa-solid fa-box-open me-2"></i>Ürün/Hizmet Kalemleri</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="p-3 bg-light border-bottom">
                            <div class="row g-2 align-items-end">
                                <div class="col-md-4">
                                    <label class="small text-muted">Stoktan Ürün Seç</label>
                                    <select id="productSelect" class="form-select select2-product">
                                        <option value="" data-price="0">Manuel Giriş / Seçiniz</option>
                                        @foreach (var prod in Model.Products)
                                        {
                                            <option value="@prod.Id" data-price="@prod.SalesPrice" data-name="@prod.ProductName">
                                                @prod.ProductName (Stok: @prod.Quantity)
                                            </option>
                                        }
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="small text-muted">Ürün Adı</label>
                                    <input type="text" id="manualName" class="form-control" />
                                </div>
                                <div class="col-md-2">
                                    <label class="small text-muted">Miktar</label>
                                    <input type="number" id="qty" class="form-control" value="1" min="1" />
                                </div>
                                <div class="col-md-2">
                                    <label class="small text-muted">Fiyat</label>
                                    <input type="number" id="price" class="form-control" value="0" step="0.01" />
                                </div>
                                <div class="col-md-1">
                                    <button type="button" id="btnAddRow" class="btn btn-primary w-100"><i class="fa-solid fa-plus"></i></button>
                                </div>
                            </div>
                        </div>

                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0" id="itemsTable">
                                <thead class="table-light">
                                    <tr>
                                        <th>Ürün Adı</th>
                                        <th width="100" class="text-center">Miktar</th>
                                        <th width="150" class="text-end">Birim Fiyat</th>
                                        <th width="150" class="text-end">Tutar</th>
                                        <th width="50"></th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                                <tfoot class="table-light fw-bold">
                                    <tr>
                                        <td colspan="3" class="text-end">GENEL TOPLAM:</td>
                                        <td class="text-end text-primary fs-5" id="grandTotal">0.00 ₺</td>
                                        <td></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
        $(document).ready(function() {
            $('.select2').select2({ theme: 'bootstrap-5' });
            $('.select2-product').select2({ theme: 'bootstrap-5' });

            // --- 1. MÜŞTERİ SEÇİMİNİ GARANTİLE ---
            // Modelden gelen müşteri ID'sini zorla seçtiriyoruz.
            var currentCustId = '@Model.CustomerId';
            if(currentCustId && currentCustId !== '@Guid.Empty') {
                $('.select2').val(currentCustId).trigger('change');
            }

            // --- 2. ÜRÜNLERİ TABLOYA DÖK ---
            var initialJson = '@Html.Raw(Model.ItemsJson)';
            if(initialJson && initialJson !== 'null' && initialJson !== '') {
                try {
                    var items = JSON.parse(initialJson);
                    items.forEach(function(item) {
                        addTableRow(item.ProductId, item.ProductName, item.Quantity, item.Price);
                    });
                    calculateGrandTotal();
                } catch(e) {
                    console.error("JSON Parse Error:", e);
                }
            }

            // Ürün seçince bilgileri doldur
            $('#productSelect').on('select2:select', function (e) {
                var selectedOption = $(this).find(':selected');
                var pPrice = parseFloat(selectedOption.attr('data-price')) || 0;
                var pName = selectedOption.attr('data-name') || "";
                $('#price').val(pPrice);
                $('#manualName').val(pName);
            });

            // Ekle Butonu
            $('#btnAddRow').click(function() {
                var prodId = $('#productSelect').val() || "";
                var prodName = $('#manualName').val();
                var qty = parseFloat($('#qty').val()) || 1;
                var price = parseFloat($('#price').val()) || 0;

                if(prodName.trim() === "") { alert("Lütfen ürün adı giriniz."); return; }

                addTableRow(prodId, prodName, qty, price);

                // Temizle
                $('#manualName').val('');
                $('#qty').val(1);
                $('#productSelect').val(null).trigger('change');
                $('#price').val(0);
                calculateGrandTotal();
            });

            // Sil Butonu
            $(document).on('click', '.btn-remove', function() {
                $(this).closest('tr').remove();
                calculateGrandTotal();
            });

            // Tabloya Satır Ekle (Inputlarla)
            function addTableRow(id, name, qty, price) {
                var total = qty * price;
                var row = `
                    <tr data-id="${id}">
                        <td>${name}</td>
                        <td>
                            <input type="number" class="form-control form-control-sm text-center item-qty" value="${qty}" min="1" onchange="updateRowTotal(this)" onkeyup="updateRowTotal(this)" />
                        </td>
                        <td>
                            <input type="number" class="form-control form-control-sm text-end item-price" value="${price}" step="0.01" onchange="updateRowTotal(this)" onkeyup="updateRowTotal(this)" />
                        </td>
                        <td class="text-end row-total">${total.toFixed(2)} ₺</td>
                        <td><button type="button" class="btn btn-sm btn-outline-danger btn-remove"><i class="fa-solid fa-trash"></i></button></td>
                    </tr>`;
                $('#itemsTable tbody').append(row);
            }

            // Satır Güncelleme (Global)
            window.updateRowTotal = function(element) {
                var row = $(element).closest('tr');
                var qty = parseFloat(row.find('.item-qty').val()) || 0;
                var price = parseFloat(row.find('.item-price').val()) || 0;
                var total = qty * price;
                row.find('.row-total').text(total.toFixed(2) + " ₺");
                calculateGrandTotal();
            }

            // Genel Toplam
            function calculateGrandTotal() {
                var total = 0;
                $('#itemsTable tbody tr').each(function() {
                    var row = $(this);
                    var qty = parseFloat(row.find('.item-qty').val()) || 0;
                    var price = parseFloat(row.find('.item-price').val()) || 0;
                    total += (qty * price);
                });
                $('#grandTotal').text(total.toFixed(2) + " ₺");
            }

            // --- KAYDETME İŞLEMİ ---
            $('#btnSave').click(function() {
                var items = [];
                $('#itemsTable tbody tr').each(function() {
                    var row = $(this);
                    var pid = row.attr('data-id');

                    if(!pid || pid === "undefined" || pid === "null" || pid === "") pid = null;

                    var name = row.find('td:eq(0)').text().trim();
                    var qty = parseFloat(row.find('.item-qty').val()) || 0;
                    var price = parseFloat(row.find('.item-price').val()) || 0;

                    items.push({
                        ProductId: pid,
                        ProductName: name,
                        Quantity: qty,
                        Price: price,
                        Total: qty * price
                    });
                });

                // JSON'a çevir ve inputa yaz
                var jsonStr = JSON.stringify(items);
                $('#ItemsJson').val(jsonStr);

                // Formu gönder
                $('#offerForm').submit();
            });
        });
    </script>
}